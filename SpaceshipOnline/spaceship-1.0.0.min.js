function Bullet(a){this.id=a,this.sprite=0,this.x=0,this.y=0,this.fx=0,this.fy=0,this.rotation=0}function Button(a){this.id=a.id?a.id:"undefined",this.x=a.x?a.x:0,this.y=a.y?a.y:0,this.width=a.width?a.width:100,this.height=a.height?a.height:24,this.sx=a.sx?a.sx:0,this.sy=a.sy?a.sy:201,this.swidth=a.swidth?a.swidth:100,this.sheight=a.sheight?a.sheight:24,this.fontFamily=a.fontFamily?a.fontFamily:"Verdana",this.fontSize=a.fontSize?a.fontSize:10,this.text=a.text?a.text:"",this.textColor=a.textColor?a.textColor:"white",this.textAlign=a.textAlign?a.textAlign:"center",this.onclick=!!a.onclick&&a.onclick,this.state=BUTTON_DEFAULT}function CheckBox(a){this.id=a.id?a.id:"undefined",this.x=a.x?a.x:0,this.y=a.y?a.y:0,this.width=a.width?a.width:24,this.height=a.height?a.height:24,this.sx=a.sx?a.sx:100,this.sy=a.sy?a.sy:201,this.swidth=a.swidth?a.swidth:24,this.sheight=a.sheight?a.sheight:24,this.fontFamily=a.fontFamily?a.fontFamily:"Verdana",this.fontSize=a.fontSize?a.fontSize:10,this.text=a.text?a.text:"",this.textColor=a.textColor?a.textColor:"white",this.textAlign=a.textAlign?a.textAlign:"left",this.onclick=!!a.onclick&&a.onclick,this.active=!!a.active&&a.active}function Client(){this.id=0,this.nickname="undefined",this.ship=1,this.x=0,this.y=0,this.shield=0,this.lastX=0,this.lastY=0,this.targetX=0,this.targetY=0,this.targetTime=0,this.fx=0,this.fy=0,this.rotation=0,this.lastRot=0,this.targetRot=0,this.accelerate=0,this.score=0,this.inMoveIt=0,this.inRotationIt=0,this.outMoveIt=0,this.outRotationIt=0,this.inAccelerateIt=0,this.fireAnim=0,this.fireTime=0}function Content(){this.backgrounds=[],this.ships=[],this.fires=[],this.bullets=[],this.interfaces=[],this.minerals=[],this.effects=[],this.counter=0}function Effect(){this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.sprite=0,this.frame=0,this.maxFrames=0,this.frameWidth=0,this.frameHeight=0,this.currentTime=0,this.fadeIn=!1,this.fadeOut=!1,this.loop=!1,this.duration=0,this.rotation=0}function Form(a){this.widgets=a,this.focus=null;for(var b=0;b<this.widgets.length;b++)this.widgets[b].form=this}function Game(a){this.canvas=a,this.context=a.getContext("2d"),this.content=new Content,this.network=new Network,this.states=[],this.state=-1,this.serverTime=0,this.fpsTotal=0,this.fps=0,this.fpsTime=0,this.ping=0,this.timePing=0,this.latency=0,this.timestamp=0,this.acc=0,this.infos=[],this.scale=1,this.isActive=!0}function StartGame(){game=new Game(document.getElementById("surface")),InitInput(),game.states=[new Menu,new Play,new Register],game.SetState(STATE_MENU),window.onfocus=function(){game.isActive=!0},window.onblur=function(){game.isActive=!1},game.WindowResize(800,600),game.content.Load(),requestAnimationFrame(function(a){game.Loop(a)})}function GetRandomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}function KeyDown(a){keys[a.keyCode]=!0,game.states[game.state].KeyDown&&game.states[game.state].KeyDown(a.keyCode),game.states[game.state].form&&game.states[game.state].form.KeyDown(a.keyCode)}function KeyUp(a){keys[a.keyCode]=!1,game.states[game.state].form&&game.states[game.state].form.KeyUp(a.keyCode)}function MouseMove(a){var b=game.canvas.getBoundingClientRect();mouseX=a.clientX-b.left,mouseY=a.clientY-b.top,game.states[game.state].form&&game.states[game.state].form.MouseMove(mouseX,mouseY)}function MouseDown(a){var b=game.canvas.getBoundingClientRect();mouseX=a.clientX-b.left,mouseY=a.clientY-b.top,game.states[game.state].form&&game.states[game.state].form.MouseDown(a.button,mouseX,mouseY)}function MouseUp(a){var b=game.canvas.getBoundingClientRect();mouseX=a.clientX-b.left,mouseY=a.clientY-b.top,game.states[game.state].form&&game.states[game.state].form.MouseUp(a.button,mouseX,mouseY)}function InitInput(){window.addEventListener("keydown",KeyDown,!1),window.addEventListener("keyup",KeyUp,!1),window.addEventListener("mousemove",MouseMove,!1),window.addEventListener("mousedown",MouseDown,!1),window.addEventListener("mouseup",MouseUp,!1)}function Label(a){this.id=a.id?a.id:"undefined",this.x=a.x?a.x:0,this.y=a.y?a.y:0,this.width=a.width?a.width:0,this.height=a.height?a.height:0,this.fontFamily=a.fontFamily?a.fontFamily:"Verdana",this.fontSize=a.fontSize?a.fontSize:10,this.text=a.text?a.text:"",this.textColor=a.textColor?a.textColor:"white",this.textAlign=a.textAlign?a.textAlign:"center"}function Menu(){var a=this,b=localStorage.getItem("username");this.form=new Form([new Label({id:"lblUsername",text:"Nickname:",x:game.canvas.width/2,y:game.canvas.height/2}),new Textbox({id:"txtUsername",x:game.canvas.width/2-64,y:game.canvas.height/2+12,text:null!=b?b:"",maxLength:20}),new CheckBox({id:"chkShip0",x:game.canvas.width/2-36,y:game.canvas.height/2+72,active:!0}),new CheckBox({id:"chkShip1",x:game.canvas.width/2+12,y:game.canvas.height/2+72}),new Button({id:"btnOkay",text:"Okay",x:game.canvas.width/2-50,y:game.canvas.height/2+98,onclick:function(b,c,d){a.OnOkayClick(b,c,d)}})])}function Mineral(a,b){this.id=a,this.type=b,this.x=0,this.y=0,this.rotation=0,this.alpha=0,this.lastX=0,this.lastY=0,this.target=null,this.time=0,this.scale=.75+.5*Math.random()}function GetRandomNickname(){return defaultNicknames[GetRandomInt(0,defaultNicknames.length-1)]}function GetRandomSentence(){return sentences[GetRandomInt(0,sentences.length-1)]}function Network(){var a=this;this.connected=!1,this.socket=io("http://"+IP+":"+PORT),this.socket.on("connect",function(){a.connected=!0,console.log("connected")}),this.socket.on("disconnect",function(){a.connected=!1,console.log("disconnect")}),this.socket.on("login_refuse",function(a){game.states[STATE_MENU].form.Find("btnOkay").Enable(),game.AddInfo(a.msg)}),this.socket.on("register_refuse",function(a){game.states[STATE_REGISTER].form.Find("btnRegister").Enable(),game.AddInfo(a.msg)}),this.socket.on("login_accept",function(a){localStorage.setItem("username",game.states[STATE_MENU].form.Find("txtUsername").text.trim()),game.SetState(STATE_PLAY),game.states[STATE_PLAY].LoginAccept(a)}),this.socket.on("register_accept",function(a){game.states[STATE_REGISTER].form.Find("btnRegister").Enable(),game.SetState(STATE_MENU)}),this.socket.on("new_client",function(a){game.states[STATE_PLAY].NewClient(a)}),this.socket.on("change_position",function(a){game.states[STATE_PLAY].ChangePosition(a)}),this.socket.on("change_rotation",function(a){game.states[STATE_PLAY].ChangeRotation(a)}),this.socket.on("remove_client",function(a){game.states[STATE_PLAY].RemoveClient(a)}),this.socket.on("chat",function(a){game.states[STATE_PLAY].AddChatMessage(a.id,a.msg)}),this.socket.on("info",function(a){game.AddInfo(a.msg)}),this.socket.on("accelerate_start",function(a){game.states[STATE_PLAY].AccelerateStart(a.id,a.it)}),this.socket.on("accelerate_stop",function(a){game.states[STATE_PLAY].AccelerateStop(a.id,a.it)}),this.socket.on("update_shield",function(a){game.states[STATE_PLAY].UpdateShield(a.id,a.shield)}),this.socket.on("new_bullet",function(a){game.states[STATE_PLAY].AddBullet(a.id,a.x,a.y,a.fx,a.fy,a.rotation,a.sprite)}),this.socket.on("remove_bullet",function(a){game.states[STATE_PLAY].RemoveBullet(a.id)}),this.socket.on("destroy_player",function(a){game.states[STATE_PLAY].DestroyPlayer(a)}),this.socket.on("score",function(a){game.states[STATE_PLAY].SetScore(a.id,a.score)}),this.socket.on("new_mineral",function(a){game.states[STATE_PLAY].AddMineral(a.id,a.type,a.x,a.y)}),this.socket.on("remove_mineral",function(a){game.states[STATE_PLAY].RemoveMineral(a.id,a.clientID)}),this.socket.on("mineral_info",function(a){game.states[STATE_PLAY].myMinerals=[a.copperium,a.silverium,a.goldinium,a.mithrilium]}),this.socket.on("space_pong",function(a){game.ping=Date.now()-game.latency})}function Play(){this.me=new Client,this.lastX=0,this.lastY=0,this.lastRot=0,this.clients=[],this.cameraX=0,this.cameraY=0,this.mapWidth=0,this.mapHeight=0,this.chat=[],this.bullets=[],this.bulletTime=0,this.minerals=[],this.effects=[],this.sendTime=0,this.sentence=0,this.myMinerals=[0,0,0,0],this.form=new Form([new Textbox({id:"txtChat",x:10,y:game.canvas.height-34,width:260,swidth:260,sy:321,maxLength:40,opacity:.5})])}function Register(){var a=this;this.form=new Form([new Label({id:"lblUsername",text:"Username:",x:game.canvas.width/2,y:game.canvas.height-2}),new Textbox({id:"txtUsername",x:game.canvas.width/2-64,y:game.canvas.height/2+12,maxLength:20}),new Label({id:"lblNickname",text:"Nickname:",x:game.canvas.width/2,y:game.canvas.height/2}),new Textbox({id:"txtNickname",x:game.canvas.width/2-64,y:game.canvas.height/2+12,maxLength:20}),new Label({id:"lblPassword",text:"Password:",x:game.canvas.width/2,y:game.canvas.height/2}),new Textbox({id:"txtPassword",x:game.canvas.width/2-64,y:game.canvas.height/2+12,password:!0,maxLength:20}),new Button({id:"btnRegister",text:"Register",onclick:function(b,c,d){a.OnRegisterClick(b,c,d)}}),new Button({id:"btnBack",text:"Back",onclick:function(b,c,d){a.OnBackClick(b,c,d)}})])}function Textbox(a){var b=this;this.id=a.id?a.id:"undefined",this.x=a.x?a.x:0,this.y=a.y?a.y:0,this.width=a.width?a.width:128,this.height=a.height?a.height:24,this.sx=a.sx?a.sx:0,this.sy=a.sy?a.sy:297,this.swidth=a.swidth?a.swidth:128,this.sheight=a.sheight?a.sheight:24,this.textColor=a.textColor?a.textColor:"white",this.fontSize=a.fontSize?a.fontSize:10,this.font=a.font?a.font:"Verdana",this.text=a.text?a.text:"",this.placeholder=a.placeholder?a.placeholder:"",this.password=!!a.password&&a.password,this.maxLength=a.maxLength?a.maxLength:20,this.opacity=a.opacity?a.opacity:1,this.time=0,this.cover="",this.hiddenInput=document.createElement("input"),this.hiddenInput.type=this.password?"password":"text",this.hiddenInput.style.position="absolute",this.hiddenInput.style.opacity=0,this.hiddenInput.style.left=this.x+game.canvas.offsetLeft+TEXTBOX_MARGIN_LEFT+"px",this.hiddenInput.style.top=this.y+game.canvas.offsetTop+"px",this.hiddenInput.style.width=this.width-TEXTBOX_MARGIN_LEFT+"px",this.hiddenInput.style.height=this.height+"px",this.hiddenInput.style.zIndex=0,this.hiddenInput.style.fontFamily=this.font,this.hiddenInput.style.fontSize=this.fontSize,this.hiddenInput.oninput=function(){b.text=b.hiddenInput.value,b.time=0},this.hiddenInput.onpropertychange=this.hiddenInput.oninput,this.maxLength&&(this.hiddenInput.maxLength=this.maxLength),this.hiddenInput.value=this.text}Bullet.prototype.Update=function(a){this.x+=this.fx*a,this.y+=this.fy*a},Bullet.prototype.Render=function(a,b){game.context.fillStyle="white",game.context.beginPath(),game.context.arc(this.x-a,this.y-b,2*game.scale,0,2*Math.PI,!1),game.context.fill()},Button.prototype.IsDisabled=function(){return this.state==BUTTON_DISABLED},Button.prototype.Disable=function(){this.state=BUTTON_DISABLED},Button.prototype.Enable=function(){this.state=BUTTON_DEFAULT},Button.prototype.MouseMove=function(a,b){a>=this.x&&a<=this.x+this.width&&b>=this.y&&b<=this.y+this.height?this.state==BUTTON_DEFAULT&&(this.state=BUTTON_HOVER):this.state==BUTTON_HOVER&&(this.state=BUTTON_DEFAULT)},Button.prototype.MouseDown=function(a,b,c){a==MOUSE_BUTTON_LEFT&&b>=this.x&&b<=this.x+this.width&&c>=this.y&&c<=this.y+this.height&&(this.state==BUTTON_HOVER&&(this.state=BUTTON_ACTIVE),this.form.focus=this)},Button.prototype.MouseUp=function(a,b,c){a==MOUSE_BUTTON_LEFT&&b>=this.x&&b<=this.x+this.width&&c>=this.y&&c<=this.y+this.height?this.state==BUTTON_ACTIVE&&(this.state=BUTTON_HOVER,this.onclick&&this.onclick(a,b,c)):this.state==BUTTON_ACTIVE&&(this.state=BUTTON_DEFAULT)},Button.prototype.Render=function(){var a=[0,-1,1,0];game.context.drawImage(game.content.interfaces[0],this.sx,this.sy+this.sheight*this.state,this.swidth,this.sheight,Math.floor(this.x),Math.floor(this.y),this.width,this.height),this.text.length>0&&(game.context.font=this.fontSize+"px "+this.fontFamily,game.context.textAlign=this.textAlign,game.context.fillStyle=this.textColor,game.context.fillText(this.text,this.x+this.width/2,this.y+this.height/2+this.fontSize/2-1+a[this.state]))},CheckBox.prototype.MouseDown=function(a,b,c){if(b>=this.x&&b<=this.x+this.width&&c>=this.y&&c<=this.y+this.height){for(var d=0;d<this.form.widgets.length;d++)this.form.widgets[d].active&&(this.form.widgets[d].active=!1);this.active=!0}},CheckBox.prototype.Render=function(){game.context.drawImage(game.content.interfaces[0],this.sx,this.sy+(this.active?this.sheight:0),this.swidth,this.sheight,Math.floor(this.x),Math.floor(this.y),this.width,this.height),this.text.length>0&&(game.context.font=this.fontSize+"px "+this.fontFamily,game.context.textAlign=this.textAlign,game.context.fillStyle=this.textColor,game.context.fillText(this.text,this.x+this.width+4,this.y+this.height/2+this.fontSize/2-1))},Client.prototype.GetSpeed=function(){return Math.sqrt(this.fx*this.fx+this.fy*this.fy)},Client.prototype.Update=function(a){for(this.accelerate>.5?this.fireAnim+=4*a:this.fireAnim-=a,this.fireAnim<0?this.fireAnim=0:this.fireAnim>1&&(this.fireAnim=1),this.fireTime+=a;this.fireTime>1;)this.fireTime-=1},Client.prototype.Render=function(a,b){game.context.save();var c=game.content.ships[this.ship];if(game.context.translate(this.x-a,this.y-b),game.context.rotate(this.rotation),game.context.scale(game.scale,game.scale),this.fireAnim>0){game.context.globalAlpha=this.fireAnim;var d=this.fireAnim+.1*Math.sin(100*this.fireTime)-.1;game.context.scale(d,d),game.context.rotate(.05*Math.cos(100*this.fireTime)*this.fireAnim),c=game.content.fires[this.ship],game.context.drawImage(c,0,0,c.width,c.height,-c.width/2,-c.height/2,c.width,c.height),game.context.scale(1/d,1/d),game.context.rotate(.05*-Math.cos(100*this.fireTime)*this.fireAnim),game.context.globalAlpha=1}if(c=game.content.ships[this.ship],game.context.drawImage(c,0,0,c.width,c.height,-c.width/2,-c.height/2,c.width,c.height),game.context.restore(),this==game.states[STATE_PLAY].me&&this.shield>0){var e=this.shield/100-1e-5;game.context.strokeStyle="#333333",game.context.beginPath(),game.context.lineWidth=3,game.context.arc(this.x-a-25,this.y-b+25,4,0,2*Math.PI,!1),game.context.stroke(),game.context.strokeStyle=e<.25?"red":e<.5?"yellow":"lime",game.context.beginPath(),game.context.lineWidth=3,game.context.arc(this.x-a-25,this.y-b+25,4,1.5*Math.PI,2*e*Math.PI-.5*Math.PI,!1),game.context.stroke()}},Client.prototype.RenderName=function(a,b){game.context.font="10px Verdana",game.context.textAlign="center",game.context.fillStyle="white",game.context.fillText(this.nickname,this.x-a,this.y-b-40)};var FPS=60,IP="185.25.148.74",PORT=7001,MAX_IMAGE_BACKGROUNDS=1,MAX_IMAGE_SHIPS=2,MAX_IMAGE_FIRES=2,MAX_IMAGE_BULLETS=1,MAX_IMAGE_INTERFACES=1,MAX_IMAGE_MINERALS=4,MAX_IMAGE_EFFECTS=2,MAX_IMAGES=MAX_IMAGE_BACKGROUNDS+MAX_IMAGE_SHIPS+MAX_IMAGE_FIRES+MAX_IMAGE_BULLETS+MAX_IMAGE_INTERFACES+MAX_IMAGE_MINERALS+MAX_IMAGE_EFFECTS,MAX_CONTENT=MAX_IMAGES,STATE_MENU=0,STATE_PLAY=1,STATE_REGISTER=2,BUTTON_DEFAULT=0,BUTTON_HOVER=1,BUTTON_ACTIVE=2,BUTTON_DISABLED=3,MOUSE_BUTTON_LEFT=0,MOUSE_BUTTON_MIDDLE=1,MOUSE_BUTTON_RIGHT=2,TEXTBOX_MARGIN_LEFT=10,KEY_ENTER=13,KEY_SHIFT=16,KEY_CTRL=17,KEY_ALT=18,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,DEFAULT_SPEED=300,CHAT_MAX_MESSAGES=15,MINERAL_COPPERIUM=0,MINERAL_SILVERIUM=1,MINERAL_GOLDINIUM=2,MINERAL_MITHRILIUM=3,GUEST=!0,MINETAL_NAMES=["Copperium","Silverium","Goldinium","Mithrilium"];Content.prototype.IsLoaded=function(){return this.counter==MAX_CONTENT},Content.prototype.Load=function(){for(var a=0;a<MAX_IMAGE_BACKGROUNDS;a++)this.backgrounds[a]=new Image,this.backgrounds[a].onload=function(){game.content.counter++},this.backgrounds[a].src="assets/backgrounds/"+a+".png";for(var a=0;a<MAX_IMAGE_SHIPS;a++)this.ships[a]=new Image,this.ships[a].onload=function(){game.content.counter++},this.ships[a].src="assets/ships/"+a+".png";for(var a=0;a<MAX_IMAGE_FIRES;a++)this.fires[a]=new Image,this.fires[a].onload=function(){game.content.counter++},this.fires[a].src="assets/fires/"+a+".png";for(var a=0;a<MAX_IMAGE_BULLETS;a++)this.bullets[a]=new Image,this.bullets[a].onload=function(){game.content.counter++},this.bullets[a].src="assets/bullets/"+a+".png";for(var a=0;a<MAX_IMAGE_INTERFACES;a++)this.interfaces[a]=new Image,this.interfaces[a].onload=function(){game.content.counter++},this.interfaces[a].src="assets/interfaces/"+a+".png";for(var a=0;a<MAX_IMAGE_MINERALS;a++)this.minerals[a]=new Image,this.minerals[a].onload=function(){game.content.counter++},this.minerals[a].src="assets/minerals/"+a+".png";for(var a=0;a<MAX_IMAGE_EFFECTS;a++)this.effects[a]=new Image,this.effects[a].onload=function(){game.content.counter++},this.effects[a].src="assets/effects/"+a+".png"},Effect.prototype.Update=function(a){this.currentTime+=a},Effect.prototype.Render=function(a,b){game.context.save();var c=game.content.effects[this.sprite];game.context.globalAlpha=1,game.context.translate(this.x-a,this.y-b),game.context.rotate(this.rotation);var d=this.currentTime/this.duration*this.maxFrames|0,e=d%(c.width/this.frameWidth),f=d/(c.width/this.frameWidth)|0;game.context.drawImage(c,e*this.frameWidth,f*this.frameHeight,this.frameWidth,this.frameHeight,-this.offsetX,-this.offsetY,this.frameWidth,this.frameHeight),game.context.restore()},Form.prototype.Find=function(a){for(var b=0;b<this.widgets.length;b++)if(this.widgets[b].id==a)return this.widgets[b];return null},Form.prototype.MouseMove=function(a,b){for(var c=0;c<this.widgets.length;c++)this.widgets[c].MouseMove&&this.widgets[c].MouseMove(a,b)},Form.prototype.MouseDown=function(a,b,c){this.focus=null;for(var d=0;d<this.widgets.length;d++)this.widgets[d].MouseDown&&this.widgets[d].MouseDown(a,b,c)},Form.prototype.MouseUp=function(a,b,c){for(var d=0;d<this.widgets.length;d++)this.widgets[d].MouseUp&&this.widgets[d].MouseUp(a,b,c)},Form.prototype.KeyDown=function(a){for(var b=0;b<this.widgets.length;b++)this.widgets[b].KeyDown&&this.widgets[b].KeyDown(a)},Form.prototype.KeyUp=function(a){for(var b=0;b<this.widgets.length;b++)this.widgets[b].KeyUp&&this.widgets[b].KeyUp(a)},Form.prototype.WindowResize=function(a,b){for(var c=0;c<this.widgets.length;c++)this.widgets[c].WindowResize&&this.widgets[c].WindowResize(a,b)},Form.prototype.Update=function(a){for(var b=0;b<this.widgets.length;b++)this.widgets[b].Update&&this.widgets[b].Update(a)},Form.prototype.Render=function(){for(var a=0;a<this.widgets.length;a++)this.widgets[a].Render&&this.widgets[a].Render()},Form.prototype.Load=function(){for(var a=0;a<this.widgets.length;a++)this.widgets[a].Load&&this.widgets[a].Load()},Form.prototype.Unload=function(){for(var a=0;a<this.widgets.length;a++)this.widgets[a].Unload&&this.widgets[a].Unload()},Game.prototype.AddInfo=function(a){this.infos.length>0&&this.infos[this.infos.length-1].msg==a||this.infos.push({text:a,time:0})},Game.prototype.Update=function(a){this.infos.length>0&&(this.infos[0].time+=2*a,this.infos[0].time>10&&this.infos.splice(0,1)),this.states[this.state].Update&&this.states[this.state].Update(a),this.states[this.state].form&&this.states[this.state].form.Update(a)},Game.prototype.RenderInfo=function(){if(this.context.font="10px Verdana",this.context.textAlign="center",this.context.fillStyle="white",this.infos.length>0){var a=this.infos[0];a.time<1?(this.context.globalAlpha=a.time,this.context.fillText(a.text,this.canvas.width/2,-5+20*a.time),this.context.globalAlpha=1):a.time<9?this.context.fillText(a.text,this.canvas.width/2,15):(this.context.globalAlpha=1-(a.time-9),this.context.fillText(a.text,this.canvas.width/2,-5+20*(1-(a.time-9))),this.context.globalAlpha=1)}},Game.prototype.Render=function(){this.context.fillStyle="#111111",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.content.IsLoaded()?this.network.connected?(this.states[this.state].Render&&this.states[this.state].Render(),this.states[this.state].form&&this.states[this.state].form.Render(),this.RenderInfo()):(this.context.font="10px Verdana",this.context.textAlign="center",this.context.fillStyle="white",this.context.fillText("connecting",this.canvas.width/2,this.canvas.height/2-5)):(this.context.font="10px Verdana",this.context.textAlign="center",this.context.fillStyle="white",this.context.fillText((this.content.counter/MAX_CONTENT*100|0)+"%",this.canvas.width/2,this.canvas.height/2-5))},Game.prototype.WindowResize=function(a,b){this.canvas.width=a,this.canvas.height=b,this.states[this.state].WindowResize&&this.states[this.state].WindowResize(a,b),this.states[this.state].form&&this.states[this.state].form.WindowResize(a,b)};var requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;Game.prototype.Loop=function(a){for(this.timePing+1e3<a&&(this.network.socket.emit("space_ping"),this.latency=Date.now(),this.timePing=a),this.acc+=a-this.timestamp;this.acc>=16;)this.acc-=16;this.Update((a-this.timestamp)/1e3),this.Render(),this.context.font="10px Verdana",this.context.textAlign="left",this.context.fillStyle="white",this.context.fillText("PING: ",10,15),this.context.fillText("FPS: ",10,25),this.context.fillStyle=this.fpsTotal>=50?"lime":this.fpsTotal>=30?"yellow":"red",this.context.fillText(this.fpsTotal,45,25),this.context.fillStyle=this.ping<=50?"lime":this.ping<=100?"yellow":"red",this.context.fillText(this.ping,45,15),this.fpsTime+1e3<a?(this.fpsTotal=this.fps,this.fps=0,this.fpsTime=a):this.fps++,this.timestamp=a,animationFrame=requestAnimationFrame(function(a){game.Loop(a)})},Game.prototype.SetState=function(a){this.state!=-1&&this.states[this.state].form&&this.states[this.state].form.Unload(),this.state=a,this.states[this.state].form&&this.states[this.state].form.Load(),game.WindowResize(800,600)};var game=null,keys=[],mouseX=0,mouseY=0;Label.prototype.Render=function(){this.text.length>0&&(game.context.font=this.fontSize+"px "+this.fontFamily,game.context.textAlign=this.textAlign,game.context.fillStyle=this.textColor,game.context.fillText(this.text,this.x+this.width/2,this.y+this.height/2+this.fontSize/2-1))},Menu.prototype.OnOkayClick=function(a,b,c){var d=this.form.Find("txtUsername"),e=this.form.Find("txtPassword"),f=this.form.Find("btnOkay"),g=this.form.Find("chkShip0"),h=g.active?0:1;GUEST?game.network.socket.emit("login_request",{username:d.text,password:"",ship:h}):game.network.socket.emit("login_request",{username:d.text,password:e.text}),f.Disable()},Menu.prototype.OnRegisterClick=function(a,b,c){game.SetState(STATE_REGISTER)},Menu.prototype.Update=function(a){},Menu.prototype.WindowResize=function(a,b){},Menu.prototype.Render=function(){game.context.drawImage(game.content.ships[0],0,0,32,32,game.canvas.width/2-40,game.canvas.height/2+38,32,32),game.context.drawImage(game.content.ships[1],0,0,32,32,game.canvas.width/2+8,game.canvas.height/2+38,32,32)},Menu.prototype.Unload=function(){},Mineral.prototype.SetTarget=function(a){this.lastX=this.x,this.lastY=this.y,this.target=a,this.time=0},Mineral.prototype.Update=function(a){this.alpha+=a,this.alpha>1&&(this.alpha=1),this.rotation+=a*Math.PI*.5},Mineral.prototype.Render=function(a,b){this.x<a||this.x>a+game.canvas.width||this.y<b||this.y>b+game.canvas.height||(game.context.fillStyle="yellow",game.context.beginPath(),game.context.arc(this.x-a,this.y-b,3,0,2*Math.PI,!1),game.context.fill())};var defaultNicknames=["Aaron","Adam","Adrian","Aiden","Alex","Alexander","Alex","Andrew","Andy","Anthony","Ajob","Tony","Arthur","Austin","Benjamin","Ben","Blake","Bobby","Bob","Brandon","Brian","Bruce","Cameron","Carl","Charles","Charlie","Christopher","Chris","Cody","Colin","Connor","Corey","Craig","Daniel","Dan","David","Dave","Donald","Don","Dylan","Edward","Eric","Elliot","Ethan","Evan","Frank","Frankie","Freddie","Fred","Gabriel","Gabe","Gary","George","Harry","Henry","Ian","Isaac","Jack","Jackson","Jacob","Jake","James","Jamie","Jason","Jay","Jeffrey","Jeff","Jeremy","Jerry","Gerry","Joel","John","Jordan","Joseph","Joshua","Justin","Kenneth","Ken","Kevin","Kyle","Lawrence","Larry","Leo","Liam","Logan","Louis","Lucas","Luke","Matthew","Matt","Maxwell","Max","Michael","Mike","Nathan","Nathaniel","Nicholas","Nick","Noah","Nolan","Oscar","Owen","Patrick","Pat","Paul","Phillip","Randy","Richard","Rich","Riley","Robert","Bob","Ronald","Ron","Roy","Ryan","Samuel","Scott","Sean","Shaun","Sebastian","Stanley","Steven","Stephen","Steve","Taylor","Theo","Thomas","Tom","Tommy","Timothy","Tim","Tristan","Tyler","Wayne","William","Billy"],sentences=["Where are we?","Silence...","The stars are so beautiful.","When will we find a planet?","What was that?!","Did you hear that?","Not my fault!","Can I do it alone?","Please, talk with me...","Asteroid?","Can we back?"];Play.prototype.FindClient=function(a){if(this.me.id==a)return this.me;for(var b=0;b<this.clients.length;b++)if(this.clients[b].id==a)return this.clients[b];return null},Play.prototype.DestroyPlayer=function(a){console.log("DestroyPlayer");var b=this.FindClient(a.id);if(null!=b){var c=new Effect;c.x=b.x,c.y=b.y,c.offsetX=32,c.offsetY=32,c.sprite=1,c.maxFrames=25,c.frameWidth=64,c.frameHeight=64,c.duration=1.25,this.effects.push(c),b.x=a.x,b.y=a.y,b.fx=0,b.fy=0,b.targetX=a.x,b.targetY=a.y,b.lastX=a.x,b.lastY=a.y,b.shield=a.shield,game.AddInfo(b.nickname+" has been destroyed!")}},Play.prototype.UpdateShield=function(a,b){var c=this.FindClient(a);null!=c&&(c.shield=b)},Play.prototype.AddChatMessage=function(a,b){if(null==a)this.chat.splice(0,0,{nickname:this.me.nickname,text:b,alpha:0});else{var c=this.FindClient(a);null!=c&&this.chat.splice(0,0,{nickname:c.nickname,text:b,alpha:0})}},Play.prototype.UpdateCamera=function(){this.cameraX=this.me.x-game.canvas.width/2,this.cameraY=this.me.y-game.canvas.height/2,this.cameraX<0&&(this.cameraX=0),this.cameraY<0&&(this.cameraY=0),this.cameraX>this.mapWidth-game.canvas.width&&(this.cameraX=this.mapWidth-game.canvas.width),this.cameraY>this.mapHeight-game.canvas.height&&(this.cameraY=this.mapHeight-game.canvas.height)},Play.prototype.KeyDown=function(a){var b=this.form.Find("txtChat");a==KEY_ENTER?b.text.length>0?(game.network.socket.emit("chat",{msg:b.text}),this.AddChatMessage(null,b.text),b.SetText(""),b.Blur()):this.form.focus==b?b.Blur():b.Focus():88!=a&&120!=a||game.network.socket.emit("gather")},Play.prototype.AddBullet=function(a,b,c,d,e,f,g){var h=new Bullet(a);h.x=b,h.y=c,h.fx=600*Math.cos(f)+d,h.fy=600*Math.sin(f)+e,h.rotation=f,this.bullets.push(h)},Play.prototype.RemoveBullet=function(a){for(var b=0;b<this.bullets.length;b++)if(this.bullets[b].id==a)return void this.bullets.splice(b,1)},Play.prototype.AddMineral=function(a,b,c,d){var e=new Mineral(a,b);e.x=c,e.y=d,this.minerals.push(e)},Play.prototype.RemoveMineral=function(a,b){for(var c=0;c<this.minerals.length;c++)if(this.minerals[c].id==a)return void this.minerals[c].SetTarget(b)},Play.prototype.Update=function(a){this.bulletTime>0&&(this.bulletTime-=4*a),this.form.focus!=this.form.Find("txtChat")&&(keys[90]||keys[122]||keys[32])&&this.bulletTime<=0&&(game.network.socket.emit("new_bullet",{x:this.me.x,y:this.me.y,fx:this.me.fx,fy:this.me.fy,rotation:this.me.rotation,sprite:0}),this.bulletTime=.25);for(var b=0;b<this.effects.length;b++)this.effects[b].Update(a),this.effects[b].duration>0&&this.effects[b].currentTime>this.effects[b].duration&&this.effects.splice(b--,1);for(var b=0;b<this.bullets.length;b++)this.bullets[b].Update(a),(this.bullets[b].x<0||this.bullets[b].x>this.mapWidth||this.bullets[b].y<0||this.bullets[b].y>this.mapHeight)&&this.bullets.splice(b--,1);for(var b=0;b<this.minerals.length;b++){var c=this.minerals[b];if(c.Update(a),null!=c.target)if(c.time+=4*a,c.time<1){var d=this.FindClient(c.target);if(null!=d){var e=d.x-c.x,f=d.y-c.y,g=Math.sqrt(e*e+f*f);e/=g,f/=g,c.x=c.lastX+(d.x-c.lastX)*c.time,c.y=c.lastY+(d.y-c.lastY)*c.time}else c.target=null}else this.minerals.splice(b--,1)}for(var b=0;b<this.minerals.length;b++)this.minerals[b].Update(a);for(var b=0;b<(this.chat.length<CHAT_MAX_MESSAGES?this.chat.length:CHAT_MAX_MESSAGES);b++)this.chat[b].alpha<1?this.chat[b].alpha+=8*a:this.chat[b].alpha=1;this.chat.length>CHAT_MAX_MESSAGES&&(this.chat[CHAT_MAX_MESSAGES].alpha-=8*a);var h=this.form.Find("txtChat");h==this.form.focus?h.opacity=1:h.opacity=.5,keys[KEY_UP]?0==this.me.accelerate&&(this.me.accelerate=1,game.network.socket.emit("accelerate_start")):1==this.me.accelerate&&(this.me.accelerate=0,game.network.socket.emit("accelerate_stop")),keys[KEY_LEFT]?this.me.rotation-=a*Math.PI*1:keys[KEY_RIGHT]&&(this.me.rotation+=a*Math.PI*1),this.me.fx+=Math.cos(this.me.rotation)*this.me.accelerate*DEFAULT_SPEED*a,this.me.fy+=Math.sin(this.me.rotation)*this.me.accelerate*DEFAULT_SPEED*a;var i=Math.sqrt(this.me.fx*this.me.fx+this.me.fy*this.me.fy);i>500&&(this.me.fx/=i,this.me.fy/=i,this.me.fx*=500,this.me.fy*=500),this.me.x+=this.me.fx*a,this.me.y+=this.me.fy*a,this.me.x<0?(this.me.fx=.1*-this.me.fx,this.me.x=0):this.me.x>this.mapWidth&&(this.me.fx=.1*-this.me.fx,this.me.x=this.mapWidth),this.me.y<0?(this.me.fy=.1*-this.me.fy,this.me.y=0):this.me.y>this.mapHeight&&(this.me.fy=.1*-this.me.fy,this.me.y=this.mapHeight);this.lastX-this.me.x,this.lastY-this.me.y;this.sendTime+=a;var l=.1;this.sendTime>l&&(game.network.socket.emit("change_position",{x:this.me.x,y:this.me.y,rotation:this.me.rotation,it:this.me.outMoveIt}),this.me.outMoveIt=this.me.outMoveIt+1&16777215,this.lastX=this.me.x,this.lastY=this.me.y),this.sendTime>l&&(this.sendTime=0),this.me.Update(a);for(var b=0;b<this.clients.length;b++)this.clients[b].Update(a);for(var b=0;b<this.clients.length;b++){var d=this.clients[b];d.targetTime+=a*(1/l),d.x=d.lastX+(d.targetX-d.lastX)*d.targetTime,d.y=d.lastY+(d.targetY-d.lastY)*d.targetTime,d.rotation=d.lastRot+(d.targetRot-d.lastRot)*d.targetTime}this.UpdateCamera()},Play.prototype.WindowResize=function(a,b){var c=this.form.Find("txtChat");c.y=b-c.height-10},Play.prototype.LoginAccept=function(a){this.me.id=a.id,this.me.x=a.x,this.me.y=a.y,this.me.shield=a.shield,this.me.ship=a.ship%2,this.lastX=a.x,this.lastY=a.y,this.targetX=a.x,this.targetY=a.y,this.me.rotation=a.rotation,this.lastRot=a.rotation,this.me.nickname=a.nickname,this.mapWidth=a.mapWidth,this.mapHeight=a.mapHeight},Play.prototype.SetScore=function(a,b){var c=this.FindClient(a);null!=c&&(c.score=b,this.SortClients())},Play.prototype.NewClient=function(a){var b=new Client;b.id=a.id,b.x=a.x,b.y=a.y,b.score=a.score,b.ship=a.ship,b.shield=a.shield,b.rotation=a.rotation,b.nickname=a.nickname,this.clients.push(b)},Play.prototype.ChangePosition=function(a){var b=this.FindClient(a.id);null!=b&&(a.it<=b.inMoveIt&&console.log("async"),a.it>b.inMoveIt&&(b.lastRot=b.rotation,b.targetRot=a.rotation,b.lastX=b.x,b.lastY=b.y,b.targetX=a.x,b.targetY=a.y,b.targetTime=0,b.inMoveIt=a.it))},Play.prototype.ChangeRotation=function(a){var b=this.FindClient(a.id);null!=b&&(a.it<=b.inRotationIt&&console.log("async"),a.it>b.inRotationIt&&(b.lastRot=b.rotation,b.targetRot=a.rotation,b.inRotationIt=a.it))},Play.prototype.AccelerateStart=function(a,b){var c=this.FindClient(a);null!=c&&b>c.inAccelerateIt&&(c.accelerate=1,c.inAccelerateIt=b)},Play.prototype.AccelerateStop=function(a,b){var c=this.FindClient(a);null!=c&&b>c.inAccelerateIt&&(c.accelerate=0,c.inAccelerateIt=b)},Play.prototype.SortClients=function(){console.log("sorting");for(var a=this.clients.length;a>1;a--)for(var b=0;b<a-1;b++)if(this.clients[b].score<this.clients[b+1].score){var c=this.clients[b];this.clients[b]=this.clients[b+1],this.clients[b+1]=c}},Play.prototype.RemoveClient=function(a){for(var b=0;b<this.clients.length;b++)if(this.clients[b].id==a.id)return void this.clients.splice(b,1)},Play.prototype.RenderChat=function(){game.context.font="10px Verdana",game.context.textAlign="left";for(var a=this.chat.length<CHAT_MAX_MESSAGES?this.chat.length:CHAT_MAX_MESSAGES,b=0,c=0;c<a;c++){b+=15*(1-this.chat[c].alpha),game.context.globalAlpha=this.chat[c].alpha,game.context.fillStyle=this.chat[c].nickname==this.me.nickname?"yellow":"lime",game.context.fillText(this.chat[c].nickname,10,game.canvas.height-39-15*c+b);var d=game.context.measureText(this.chat[c].nickname).width+11;game.context.fillStyle="white",game.context.fillText(": "+this.chat[c].text,d,game.canvas.height-39-15*c+b);
}if(this.chat.length>CHAT_MAX_MESSAGES&&this.chat[CHAT_MAX_MESSAGES].alpha>0){game.context.globalAlpha=this.chat[CHAT_MAX_MESSAGES].alpha,game.context.fillStyle=this.chat[CHAT_MAX_MESSAGES].nickname==this.me.nickname?"yellow":"lime",game.context.fillText(this.chat[CHAT_MAX_MESSAGES].nickname,10,game.canvas.height-39-15*CHAT_MAX_MESSAGES+b);var d=game.context.measureText(this.chat[CHAT_MAX_MESSAGES].nickname).width+11;game.context.fillStyle="white",game.context.fillText(": "+this.chat[CHAT_MAX_MESSAGES].text,d,game.canvas.height-39-15*CHAT_MAX_MESSAGES+b)}game.context.globalAlpha=1},Play.prototype.RenderClientList=function(){var a=this.clients.length;game.context.font="10px Verdana",game.context.textAlign="left",game.context.fillStyle="lime",game.context.fillText("Ranking:",game.canvas.width-100,15),game.context.fillStyle="white";for(var b=0;b<this.clients.length;b++)if(this.clients[b].score<=this.me.score){a=b;break}for(var b=0;b<this.clients.length;b++)b<a?game.context.fillText(b+1+": "+this.clients[b].nickname+" - "+this.clients[b].score,game.canvas.width-100,30+15*b):b==a?(game.context.fillText(b+1+": "+this.me.nickname+" - "+this.me.score,game.canvas.width-10,30+15*b),game.context.fillText(b+2+": "+this.clients[b].nickname+" - "+this.clients[b].score,game.canvas.width-100,45+15*b)):game.context.fillText(b+2+": "+this.clients[b].nickname+" - "+this.clients[b].score,game.canvas.width-100,45+15*b);0==this.clients.length?game.context.fillText("1: "+this.me.nickname+" - "+this.me.score,game.canvas.width-100,30):this.clients.length==a&&game.context.fillText(a+1+": "+this.me.nickname+" - "+this.me.score,game.canvas.width-100,30+15*a)},Play.prototype.RenderMinimap=function(){},Play.prototype.RenderMineralsInfo=function(){},Play.prototype.Render=function(){for(var a=0;a<this.bullets.length;a++)this.bullets[a].Render(this.cameraX,this.cameraY);for(var a=0;a<this.minerals.length;a++)this.minerals[a].Render(this.cameraX,this.cameraY);for(var a=0;a<this.clients.length;a++)this.clients[a].Render(this.cameraX,this.cameraY);this.me.Render(this.cameraX,this.cameraY);for(var a=0;a<this.effects.length;a++)this.effects[a].Render(this.cameraX,this.cameraY);for(var a=0;a<this.clients.length;a++)this.clients[a].RenderName(this.cameraX,this.cameraY);this.RenderChat(),this.RenderClientList(),this.RenderMinimap(),this.RenderMineralsInfo()},Register.prototype.OnBackClick=function(a,b,c){game.SetState(STATE_MENU)},Register.prototype.OnRegisterClick=function(a,b,c){var d=this.form.Find("txtUsername"),e=this.form.Find("txtNickname"),f=this.form.Find("txtPassword"),g=this.form.Find("btnRegister"),h=d.text.trim(),i=e.text.trim(),j=f.text.trim();game.network.socket.emit("register_request",{username:h,nickname:i,password:j}),g.Disable()},Register.prototype.Update=function(a){},Register.prototype.WindowResize=function(a,b){var c=this.form.Find("lblUsername");c.x=game.canvas.width/2,c.y=game.canvas.height/2;var d=this.form.Find("txtUsername");d.x=game.canvas.width/2-d.width/2,d.y=c.y+12;var e=this.form.Find("lblNickname");e.x=game.canvas.width/2,e.y=d.y+32;var f=this.form.Find("txtNickname");f.x=game.canvas.width/2-f.width/2,f.y=e.y+8;var g=this.form.Find("lblPassword");g.x=game.canvas.width/2,g.y=f.y+32;var h=this.form.Find("txtPassword");h.x=game.canvas.width/2-h.width/2,h.y=g.y+12;var i=this.form.Find("btnRegister");i.x=game.canvas.width/2-i.width/2,i.y=h.y+32;var j=this.form.Find("btnBack");j.x=game.canvas.width/2-j.width/2,j.y=i.y+32},Register.prototype.Render=function(){for(var a=game.content.backgrounds[0],b=0;b<=Math.ceil(game.canvas.width/a.width);b++)for(var c=0;c<=Math.ceil(game.canvas.height/a.height);c++){var d=b*a.width,e=c*a.height;game.context.drawImage(a,0,0,a.width,a.height,d,e,a.width,a.height)}},Register.prototype.Unload=function(){},Textbox.prototype.Blur=function(){this.form.focus=null,this.hiddenInput.blur()},Textbox.prototype.Focus=function(){this.form.focus=this,this.hiddenInput.focus(),this.time=0},Textbox.prototype.SetText=function(a){this.hiddenInput.value=a,this.text=a},Textbox.prototype.Update=function(a){for(this.hiddenInput.style.left=this.x+game.canvas.offsetLeft+"px",this.hiddenInput.style.top=this.y+game.canvas.offsetTop+"px",this.time+=a;this.time>1;)this.time-=1},Textbox.prototype.KeyDown=function(a){this.form.focus==this&&this.hiddenInput.focus()},Textbox.prototype.MouseDown=function(a,b,c){a==MOUSE_BUTTON_LEFT&&b>=this.x&&b<=this.x+this.width&&c>=this.y&&c<=this.y+this.height&&(this.state==BUTTON_HOVER&&(this.state=BUTTON_ACTIVE),this.Focus())},Textbox.prototype.Render=function(){if(this.cover.length!=this.text.length){this.cover="";for(var a=0;a<this.text.length;a++)this.cover+=String.fromCharCode(8226)}var b=this.password?this.cover:this.text;game.context.globalAlpha=this.opacity,game.context.drawImage(game.content.interfaces[0],this.sx,this.sy,this.swidth,this.sheight,Math.floor(this.x),Math.floor(this.y),this.width,this.height),game.context.globalAlpha=1,game.context.font=this.fontSize+"px "+this.font,game.context.textAlign="left",game.context.fillStyle=this.textColor,game.context.save(),game.context.rect(this.x+TEXTBOX_MARGIN_LEFT,this.y,this.width-2*TEXTBOX_MARGIN_LEFT,this.height),game.context.clip();var c=this.x+TEXTBOX_MARGIN_LEFT,d=game.context.measureText(b).width;if(d+3*TEXTBOX_MARGIN_LEFT<this.width?game.context.fillText(b,Math.floor(c),Math.floor(this.y+this.height/2+this.fontSize/2-1)):game.context.fillText(b,Math.floor(c-3*TEXTBOX_MARGIN_LEFT-(d-this.width)),Math.floor(this.y+this.height/2+this.fontSize/2-1)),game.context.restore(),this.hiddenInput.selectionStart==this.hiddenInput.selectionEnd){if(this.form.focus==this&&this.time<.5){var e=game.context.measureText(b.substring(0,this.hiddenInput.selectionStart));if(game.context.strokeStyle=this.textColor,game.context.beginPath(),game.context.lineWidth=1,d+3*TEXTBOX_MARGIN_LEFT<this.width){var f=Math.floor(this.x+TEXTBOX_MARGIN_LEFT+e.width);game.context.moveTo(f,this.y+this.height/2-this.fontSize/2),game.context.lineTo(f,this.y+this.height/2+this.fontSize/2)}else game.context.moveTo(Math.round(this.x-2*TEXTBOX_MARGIN_LEFT-(d-this.width)+e.width),this.y+this.height/2-this.fontSize/2),game.context.lineTo(Math.round(this.x-2*TEXTBOX_MARGIN_LEFT-(d-this.width)+e.width),this.y+this.height/2+this.fontSize/2);game.context.stroke()}}else if(this.hiddenInput.selectionStart<this.hiddenInput.selectionEnd){var g=this.x+TEXTBOX_MARGIN_LEFT+game.context.measureText(b.substring(0,this.hiddenInput.selectionStart)).width,h=game.context.measureText(b.substring(this.hiddenInput.selectionStart,this.hiddenInput.selectionEnd)).width;d+3*TEXTBOX_MARGIN_LEFT>=this.width&&(g-=3*TEXTBOX_MARGIN_LEFT+(d-this.width));var i=game.context.globalAlpha;game.context.globalAlpha=.5,game.context.fillStyle="#FFFFFF",game.context.fillRect(g,this.y+this.height/2-this.fontSize/2,h,this.fontSize),game.context.globalAlpha=i}},Textbox.prototype.Load=function(){document.body.appendChild(this.hiddenInput)},Textbox.prototype.Unload=function(){document.body.removeChild(this.hiddenInput)};